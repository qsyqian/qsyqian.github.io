<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Flannel源码分析 - To be a programer. Not just to be a programer.</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="qsyqian" />
  <meta name="description" content="Flannel源码分析 前言 flannel作为kubernetes的一种网络解决方案，在社区是比较活跃的。支持多种backend。 flanne" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.59.1" />


<link rel="canonical" href="https://qsyqian.github.io/post/flannel-source-code-analysis/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Flannel源码分析" />
<meta property="og:description" content="Flannel源码分析 前言 flannel作为kubernetes的一种网络解决方案，在社区是比较活跃的。支持多种backend。 flanne" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qsyqian.github.io/post/flannel-source-code-analysis/" />
<meta property="article:published_time" content="2019-09-12T16:59:05+08:00" />
<meta property="article:modified_time" content="2019-09-12T16:59:05+08:00" />
<meta itemprop="name" content="Flannel源码分析">
<meta itemprop="description" content="Flannel源码分析 前言 flannel作为kubernetes的一种网络解决方案，在社区是比较活跃的。支持多种backend。 flanne">


<meta itemprop="datePublished" content="2019-09-12T16:59:05&#43;08:00" />
<meta itemprop="dateModified" content="2019-09-12T16:59:05&#43;08:00" />
<meta itemprop="wordCount" content="4901">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flannel源码分析"/>
<meta name="twitter:description" content="Flannel源码分析 前言 flannel作为kubernetes的一种网络解决方案，在社区是比较活跃的。支持多种backend。 flanne"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Jane</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/">This is Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Jane
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/">This is Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://qsyqian.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Flannel源码分析</h1>
      
      <div class="post-meta">
        <time datetime="2019-09-12" class="post-time">
          2019-09-12
        </time>
        
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#flannel源码分析">Flannel源码分析</a>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#1-参数解析">1.参数解析</a></li>
<li><a href="#2-main函数结构">2.main函数结构</a></li>
<li><a href="#3-第一步-创建subnetmanager">3.第一步：创建SubnetManager</a></li>
<li><a href="#4-第二步-创建backend">4.第二步：创建backend</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h1 id="flannel源码分析">Flannel源码分析</h1>

<h2 id="前言">前言</h2>

<p>flannel作为kubernetes的一种网络解决方案，在社区是比较活跃的。支持多种backend。</p>

<p>flannel源码地址在：<a href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a></p>

<p>从官网上把flannel的代码clone下来，目录结构如下：</p>

<pre><code class="language-shell">$ ll -ah
total 222K
drwxr-xr-x 1 user 197121    0 8月  30 18:37 ./
drwxr-xr-x 1 user 197121    0 8月  30 18:31 ../
-rw-r--r-- 1 user 197121  351 8月  30 18:33 .appveyor.yml
-rw-r--r-- 1 user 197121   56 8月  30 18:33 .dockerignore
drwxr-xr-x 1 user 197121    0 9月  17 09:34 .git/
drwxr-xr-x 1 user 197121    0 8月  30 18:33 .github/
-rw-r--r-- 1 user 197121  147 8月  30 18:33 .gitignore
drwxr-xr-x 1 user 197121    0 9月  17 11:22 .idea/
-rw-r--r-- 1 user 197121  411 8月  30 18:33 .travis.yml
drwxr-xr-x 1 user 197121    0 8月  30 18:33 backend/
-rw-r--r-- 1 user 197121 3.7K 8月  30 18:33 bill-of-materials.json
-rw-r--r-- 1 user 197121   98 8月  30 18:33 bill-of-materials.override.json
-rw-r--r-- 1 user 197121 3.1K 8月  30 18:33 code-of-conduct.md
-rw-r--r-- 1 user 197121 2.5K 8月  30 18:33 CONTRIBUTING.md
-rw-r--r-- 1 user 197121 1.5K 8月  30 18:33 DCO
drwxr-xr-x 1 user 197121    0 8月  30 18:33 dist/
-rw-r--r-- 1 user 197121  427 8月  30 18:33 Dockerfile.amd64
-rw-r--r-- 1 user 197121  504 8月  30 18:33 Dockerfile.arm
-rw-r--r-- 1 user 197121  494 8月  30 18:33 Dockerfile.arm64
-rw-r--r-- 1 user 197121  508 8月  30 18:33 Dockerfile.ppc64le
-rw-r--r-- 1 user 197121  504 8月  30 18:33 Dockerfile.s390x
drwxr-xr-x 1 user 197121    0 8月  30 18:33 Documentation/
-rw-r--r-- 1 user 197121  11K 8月  30 18:33 glide.lock
-rw-r--r-- 1 user 197121 1.6K 8月  30 18:33 glide.yaml
-rwxr-xr-x 1 user 197121  298 8月  30 18:33 header-check.sh*
drwxr-xr-x 1 user 197121    0 8月  30 18:33 images/
-rw-r--r-- 1 user 197121  12K 8月  30 18:33 LICENSE
drwxr-xr-x 1 user 197121    0 8月  30 18:33 logos/
-rw-r--r-- 1 user 197121  21K 8月  30 18:33 main.go
-rw-r--r-- 1 user 197121   98 8月  30 18:33 MAINTAINERS
-rw-r--r-- 1 user 197121  12K 8月  30 18:33 Makefile
drwxr-xr-x 1 user 197121    0 8月  30 18:33 network/
-rw-r--r-- 1 user 197121  131 8月  30 18:33 NOTICE
-rw-r--r-- 1 user 197121  212 8月  30 18:33 OWNERS
-rw-r--r-- 1 user 197121  75K 8月  30 18:33 packet-01.png
drwxr-xr-x 1 user 197121    0 8月  30 18:33 pkg/
-rw-r--r-- 1 user 197121 4.3K 8月  30 18:33 README.md
drwxr-xr-x 1 user 197121    0 8月  30 18:33 subnet/
drwxr-xr-x 1 user 197121    0 8月  30 18:33 vendor/
drwxr-xr-x 1 user 197121    0 8月  30 18:33 version/
</code></pre>

<p>这里介绍几个主要目录的用途：</p>

<ul>
<li>backend，flannel支持多种flannel，比如host-gw、vxlan等</li>
<li>dist，一些脚本和dockerfile文件</li>
<li>network，对主机的iptables进行操作</li>
<li>pkg，外部可引用的包</li>
<li>subnet，flannel中每个host对应一个subnet</li>
<li>./main.go，flannel程序的入口</li>
</ul>

<p>经过上述分析，分析flannel的源代码就从./main.go文件入手。</p>

<h2 id="1-参数解析">1.参数解析</h2>

<p>./main.go中结构体CmdLineOpts包含了所有命令行传入的参数解析，具体如下：</p>

<pre><code class="language-go">type CmdLineOpts struct {
	etcdEndpoints          string
	etcdPrefix             string
	etcdKeyfile            string
	etcdCertfile           string
	etcdCAFile             string
	etcdUsername           string
	etcdPassword           string
    // 上述的etcd参数，指的是如果采用etcd作为后端subnet存储的话，要提供上述etcd连接参数
	help                   bool
	version                bool
    // 帮助和打印出version
	kubeSubnetMgr          bool
    // 如果上述kubeSubnetMgr为true，则使用kube-apiserver为subnet的后端存储（其实是将每个node的subnet信息存入到了node的annotations中）
	kubeApiUrl             string
	kubeAnnotationPrefix   string
	kubeConfigFile         string
    // 上述三个kube相关的参数标识连接kube-apiserver的必要参数
	iface                  flagSlice
	ifaceRegex             flagSlice
    // iface参数，用来作为多节点通信的网卡，不指定的话，flannel会使用默认网卡和其上IP信息
	ipMasq                 bool
    // ipMasq （具体意义待定）
	subnetFile             string
    // 存储subnet的文件，默认为/run/flannel/subnet.env，其中存储了整个集群的pod subnet段，本机上pod的subnet段等信息
	subnetDir              string
	publicIP               string
    // 用来跨节点通信的IP地址，和上述iface参数类似
	subnetLeaseRenewMargin int
    // subnet是以lease（租约）的形式存储起来的，到期会自动过期。需要定时续租，改时间表示在lease过期前多少时间续租，单位是min，默认值是60
	healthzIP              string
	healthzPort            int
    // 用来健康检查的IP和PORT
	charonExecutablePath   string
	charonViciUri          string
	iptablesResyncSeconds  int
    // 同步iptables规则的时间间隔。默认5s同步一次
	iptablesForwardRules   bool
    // add default accept rules to FORWARD chain in iptables
	netConfPath            string
    // networkConfiguration PATH
}
</code></pre>

<p>main.go中首先是init函数对命令行传入参数进行赋值，没有赋值的采用默认值。然后进到main()函数中。</p>

<h2 id="2-main函数结构">2.main函数结构</h2>

<p>首先看一下main函数的主要结构，然后分步分析：</p>

<pre><code class="language-go">func main() {
	// 如果是打印版本，则打印退出
	if opts.version {
		fmt.Fprintln(os.Stderr, version.Version)
		os.Exit(0)
	}

	flagutil.SetFlagsFromEnv(flannelFlags, &quot;FLANNELD&quot;)

	// Validate flags
    // 验证参数，如果续租时间大于24*60或者小于等于0，则直接报错。
    // 因为默认的租约时间为24*60
	if opts.subnetLeaseRenewMargin &gt;= 24*60 || opts.subnetLeaseRenewMargin &lt;= 0 {
		log.Error(&quot;Invalid subnet-lease-renew-margin option, out of acceptable range&quot;)
		os.Exit(1)
	}
    
    // Work out which interface to use
    // 找出externalInterface，很简单，如果命令行参数指定了使用哪个网卡，则直接使用，若没指定，则需要自己去找默认的网卡，主要是LookupExtIface这个函数来寻找。这个函数中所调用的ip.GetDefaultGatewayIface()是位于pkg目录下，在自己写程序来获取linux主机默认网卡和ip信息的时候也可以直接引用该函数
	var extIface *backend.ExternalInterface
	var err error
	// Check the default interface only if no interfaces are specified
	if len(opts.iface) == 0 &amp;&amp; len(opts.ifaceRegex) == 0 {
		extIface, err = LookupExtIface(&quot;&quot;, &quot;&quot;)
		if err != nil {
			log.Error(&quot;Failed to find any valid interface to use: &quot;, err)
			os.Exit(1)
		}
	} else {
		// Check explicitly specified interfaces
		for _, iface := range opts.iface {
			extIface, err = LookupExtIface(iface, &quot;&quot;)
			if err != nil {
				log.Infof(&quot;Could not find valid interface matching %s: %s&quot;, iface, err)
			}

			if extIface != nil {
				break
			}
		}

		// Check interfaces that match any specified regexes
		if extIface == nil {
			for _, ifaceRegex := range opts.ifaceRegex {
				extIface, err = LookupExtIface(&quot;&quot;, ifaceRegex)
				if err != nil {
					log.Infof(&quot;Could not find valid interface matching %s: %s&quot;, ifaceRegex, err)
				}

				if extIface != nil {
					break
				}
			}
		}

		if extIface == nil {
			// Exit if any of the specified interfaces do not match
			log.Error(&quot;Failed to find interface to use that matches the interfaces and/or regexes provided&quot;)
			os.Exit(1)
		}
	}
    
    // 第一步：创建SubnetManager，主要是用来管理subnet的。
    sm, err := newSubnetManager()
	if err != nil {
		log.Error(&quot;Failed to create SubnetManager: &quot;, err)
		os.Exit(1)
	}
	log.Infof(&quot;Created subnet manager: %s&quot;, sm.Name())
    
    // 下述这段代码是控制程序优雅退出的，首先是创建了sigs channel，类型为os.Signal,buffer为1.
    // 此处两个golang的用法，第一个是context，第二个是sync.waitGroup
    // Register for SIGINT and SIGTERM
	log.Info(&quot;Installing signal handlers&quot;)
	sigs := make(chan os.Signal, 1)
	signal.Notify(sigs, os.Interrupt, syscall.SIGTERM)

	// This is the main context that everything should run in.
	// All spawned goroutines should exit when cancel is called on this context.
	// Go routines spawned from main.go coordinate using a WaitGroup. This provides a mechanism to allow the shutdownHandler goroutine
	// to block until all the goroutines return . If those goroutines spawn other goroutines then they are responsible for
	// blocking and returning only when cancel() is called.
	// 创建全局的ctx
    ctx, cancel := context.WithCancel(context.Background())
	
    // 创建任务
    wg := sync.WaitGroup{}

   // 添加一个任务
	wg.Add(1)
	go func() {
        // shutdownHander中如果监听到系统信号，则调用cancel函数，那么所有的调用都将终止
		shutdownHandler(ctx, sigs, cancel)
		wg.Done()
	}()
    
    // 如果定义了健康检查端口，则要启动一个http服务监听该端口
    if opts.healthzPort &gt; 0 {
		// It's not super easy to shutdown the HTTP server so don't attempt to stop it cleanly
		go mustRunHealthz()
	}
    
    // 第二步：创建backend，并且通过该backend来注册subnet
    // Create a backend manager then use it to create the backend and register the network with it.
	bm := backend.NewManager(ctx, sm, extIface)
	be, err := bm.GetBackend(config.BackendType)
	if err != nil {
		log.Errorf(&quot;Error fetching backend: %s&quot;, err)
		cancel()
		wg.Wait()
		os.Exit(1)
	}

    // 注册subnet
	bn, err := be.RegisterNetwork(ctx, wg, config)
	if err != nil {
		log.Errorf(&quot;Error registering network: %s&quot;, err)
		cancel()
		wg.Wait()
		os.Exit(1)
	}
    
    // 第三步：如果指定了ipMasq，则定期同步iptables
    // Set up ipMasq if needed
	if opts.ipMasq {
		if err = recycleIPTables(config.Network, bn.Lease()); err != nil {
			log.Errorf(&quot;Failed to recycle IPTables rules, %v&quot;, err)
			cancel()
			wg.Wait()
			os.Exit(1)
		}
		log.Infof(&quot;Setting up masking rules&quot;)
		go network.SetupAndEnsureIPTables(network.MasqRules(config.Network, bn.Lease()), opts.iptablesResyncSeconds)
	}
    
    // 第四步：iptablesForwardRules指定的话，定期去同步指定的iptables
    // Always enables forwarding rules. This is needed for Docker versions &gt;1.13 (https://docs.docker.com/engine/userguide/networking/default_network/container-communication/#container-communication-between-hosts)
	// In Docker 1.12 and earlier, the default FORWARD chain policy was ACCEPT.
	// In Docker 1.13 and later, Docker sets the default policy of the FORWARD chain to DROP.
	if opts.iptablesForwardRules {
		log.Infof(&quot;Changing default FORWARD chain policy to ACCEPT&quot;)
		go network.SetupAndEnsureIPTables(network.ForwardRules(config.Network.String()), opts.iptablesResyncSeconds)
	}
    
    // 第五步：写入subnet file
    if err := WriteSubnetFile(opts.subnetFile, config.Network, opts.ipMasq, bn); err != nil {
		// Continue, even though it failed.
		log.Warningf(&quot;Failed to write subnet file: %s&quot;, err)
	} else {
		log.Infof(&quot;Wrote subnet file to %s&quot;, opts.subnetFile)
	}
    
    // 第六步：backend run起来
    // Start &quot;Running&quot; the backend network. This will block until the context is done so run in another goroutine.
	log.Info(&quot;Running backend.&quot;)
	wg.Add(1)
	go func() {
		bn.Run(ctx)
		wg.Done()
	}()
    
    // 第七步：kube subnet mgr监听subnet lease
    // Kube subnet mgr doesn't lease the subnet for this node - it just uses the podCidr that's already assigned.
	if !opts.kubeSubnetMgr {
		err = MonitorLease(ctx, sm, bn, &amp;wg)
		if err == errInterrupted {
			// The lease was &quot;revoked&quot; - shut everything down
			cancel()
		}
	}

    
    log.Info(&quot;Waiting for all goroutines to exit&quot;)
	// Block waiting for all the goroutines to finish.
	wg.Wait()
	log.Info(&quot;Exiting cleanly...&quot;)
	os.Exit(0)
    
</code></pre>

<p>上述main函数中列出了7个主要的步骤，下面依次分析。</p>

<h2 id="3-第一步-创建subnetmanager">3.第一步：创建SubnetManager</h2>

<p>main.go中的newSubnetManager函数：</p>

<pre><code class="language-go">func newSubnetManager() (subnet.Manager, error) {
	if opts.kubeSubnetMgr {
		return kube.NewSubnetManager(opts.kubeApiUrl, opts.kubeConfigFile, opts.kubeAnnotationPrefix, opts.netConfPath)
	}

	cfg := &amp;etcdv2.EtcdConfig{
		Endpoints: strings.Split(opts.etcdEndpoints, &quot;,&quot;),
		Keyfile:   opts.etcdKeyfile,
		Certfile:  opts.etcdCertfile,
		CAFile:    opts.etcdCAFile,
		Prefix:    opts.etcdPrefix,
		Username:  opts.etcdUsername,
		Password:  opts.etcdPassword,
	}

	// Attempt to renew the lease for the subnet specified in the subnetFile
	prevSubnet := ReadCIDRFromSubnetFile(opts.subnetFile, &quot;FLANNEL_SUBNET&quot;)

	return etcdv2.NewLocalManager(cfg, prevSubnet)
}
</code></pre>

<p>如果使用了kubeSubnetMgr，则调用kube.NewSubnetManager，否则调用etcdv2。这一点需要说明的是etcd发展到现在支持不同的版本，v2和v3，且v3版本具有很多优势。flannel仓库中v2版本相关的代码提交是2 years之前，因此可见目前flannel实际上只支持kube-apiserver作为后端存储，也是默认的存储方式。</p>

<p>./flannel/subnet/kube/kube.go：</p>

<pre><code class="language-go">type kubeSubnetManager struct {
	// 往node的yaml文件中添加的annotations
	annotations    annotations
	// 与kube-apiserver交互的client
	client         clientset.Interface
    // 运行在哪个node上
	nodeName       string
    // node lister
	nodeStore      listers.NodeLister
    // node controller
	nodeController cache.Controller
	subnetConf     *subnet.Config
	events         chan subnet.Event
}
</code></pre>

<p>下面进入flannel/subnet/kube/kube.go里的NewSubnetManager函数中，看看都干了啥：</p>

<pre><code class="language-go">func NewSubnetManager(apiUrl, kubeconfig, prefix, netConfPath string) (subnet.Manager, error) {
	//先看看入参函数：kube-apiserver的地址，kubeconfig的地址，prefix是给node打anno的时候前缀，netConfPath是配置存储目录，实际上安装完成之后，是通过configmap的形式挂载到/etc/kube-flannel/net-conf.json里的
	var cfg *rest.Config
	var err error
	// Try to build kubernetes config from a master url or a kubeconfig filepath. If neither masterUrl
	// or kubeconfigPath are passed in we fall back to inClusterConfig. If inClusterConfig fails,
	// we fallback to the default config.
	cfg, err = clientcmd.BuildConfigFromFlags(apiUrl, kubeconfig)
	if err != nil {
		return nil, fmt.Errorf(&quot;fail to create kubernetes config: %v&quot;, err)
	}

	c, err := clientset.NewForConfig(cfg)
	if err != nil {
		return nil, fmt.Errorf(&quot;unable to initialize client: %v&quot;, err)
	}
    // 上述是通过提供的配置，创建clientset，用来连接kube-apiserver

	// The kube subnet mgr needs to know the k8s node name that it's running on so it can annotate it.
	// If we're running as a pod then the POD_NAME and POD_NAMESPACE will be populated and can be used to find the node
	// name. Otherwise, the environment variable NODE_NAME can be passed in.
	// 获取nodename
    nodeName := os.Getenv(&quot;NODE_NAME&quot;)
	if nodeName == &quot;&quot; {
		podName := os.Getenv(&quot;POD_NAME&quot;)
		podNamespace := os.Getenv(&quot;POD_NAMESPACE&quot;)
		if podName == &quot;&quot; || podNamespace == &quot;&quot; {
			return nil, fmt.Errorf(&quot;env variables POD_NAME and POD_NAMESPACE must be set&quot;)
		}

		pod, err := c.Pods(podNamespace).Get(podName, metav1.GetOptions{})
		if err != nil {
			return nil, fmt.Errorf(&quot;error retrieving pod spec for '%s/%s': %v&quot;, podNamespace, podName, err)
		}
		nodeName = pod.Spec.NodeName
		if nodeName == &quot;&quot; {
			return nil, fmt.Errorf(&quot;node name not present in pod spec '%s/%s'&quot;, podNamespace, podName)
		}
	}

    // 读取网络配置文件
	netConf, err := ioutil.ReadFile(netConfPath)
	if err != nil {
		return nil, fmt.Errorf(&quot;failed to read net conf: %v&quot;, err)
	}

    // 解析网络配置
	sc, err := subnet.ParseConfig(string(netConf))
	if err != nil {
		return nil, fmt.Errorf(&quot;error parsing subnet config: %s&quot;, err)
	}

    // 初始化并运行subnetManager，传入的参数有clientset，网络配置，nodename，anno前缀，具体的new和Run函数下文分析
	sm, err := newKubeSubnetManager(c, sc, nodeName, prefix)
	if err != nil {
		return nil, fmt.Errorf(&quot;error creating network manager: %s&quot;, err)
	}
	go sm.Run(context.Background())

    // 下面确保hasSynced
	glog.Infof(&quot;Waiting %s for node controller to sync&quot;, nodeControllerSyncTimeout)
	err = wait.Poll(time.Second, nodeControllerSyncTimeout, func() (bool, error) {
		return sm.nodeController.HasSynced(), nil
	})
	if err != nil {
		return nil, fmt.Errorf(&quot;error waiting for nodeController to sync state: %v&quot;, err)
	}
	glog.Infof(&quot;Node controller sync successful&quot;)

	return sm, nil
}
</code></pre>

<p>下面去看看如何newKubeSubnetManager和让其Run起来的。</p>

<pre><code class="language-go">func newKubeSubnetManager(c clientset.Interface, sc *subnet.Config, nodeName, prefix string) (*kubeSubnetManager, error) {
   var err error
   var ksm kubeSubnetManager
   ksm.annotations, err = newAnnotations(prefix)
   if err != nil {
      return nil, err
   }
   ksm.client = c
   ksm.nodeName = nodeName
   ksm.subnetConf = sc
   ksm.events = make(chan subnet.Event, 5000)
   indexer, controller := cache.NewIndexerInformer(
      &amp;cache.ListWatch{
         ListFunc: func(options metav1.ListOptions) (runtime.Object, error) {
            return ksm.client.CoreV1().Nodes().List(options)
         },
         WatchFunc: func(options metav1.ListOptions) (watch.Interface, error) {
            return ksm.client.CoreV1().Nodes().Watch(options)
         },
      },
      &amp;v1.Node{},
      resyncPeriod,
      cache.ResourceEventHandlerFuncs{
         AddFunc: func(obj interface{}) {
            ksm.handleAddLeaseEvent(subnet.EventAdded, obj)
         },
         UpdateFunc: ksm.handleUpdateLeaseEvent,
         DeleteFunc: func(obj interface{}) {
            node, isNode := obj.(*v1.Node)
            // We can get DeletedFinalStateUnknown instead of *api.Node here and we need to handle that correctly.
            if !isNode {
               deletedState, ok := obj.(cache.DeletedFinalStateUnknown)
               if !ok {
                  glog.Infof(&quot;Error received unexpected object: %v&quot;, obj)
                  return
               }
               node, ok = deletedState.Obj.(*v1.Node)
               if !ok {
                  glog.Infof(&quot;Error deletedFinalStateUnknown contained non-Node object: %v&quot;, deletedState.Obj)
                  return
               }
               obj = node
            }
            ksm.handleAddLeaseEvent(subnet.EventRemoved, obj)
         },
      },
      cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc},
   )
   ksm.nodeController = controller
   ksm.nodeStore = listers.NewNodeLister(indexer)
   return &amp;ksm, nil
}
</code></pre>

<p>总结一下上述函数都干了啥：</p>

<ul>
<li>初始化kubeSubnetManager</li>
<li>ksm主要是对集群中node进行监听，因为flannel是根据node来划分网段的</li>
<li>根据监听到的node的事件，放入到ksm的events channel中</li>
</ul>

<p>此外，ksm.Run函数就是运行起来。</p>

<h2 id="4-第二步-创建backend">4.第二步：创建backend</h2>

<p>首先看backend/manager.go中的NewManager函数</p>

<pre><code class="language-go">func NewManager(ctx context.Context, sm subnet.Manager, extIface *ExternalInterface) Manager {
   return &amp;manager{
      ctx:      ctx,
      sm:       sm,
      extIface: extIface,
      active:   make(map[string]Backend),
   }
}
</code></pre>

<p>只是返回了一个manager对象：</p>

<pre><code class="language-go">type manager struct {
   ctx      context.Context
    // 上文创建好的ksm
   sm       subnet.Manager
    // 用来与外界通信的interface
   extIface *ExternalInterface
    // 互斥锁
   mux      sync.Mutex
   active   map[string]Backend
   wg       sync.WaitGroup
}
</code></pre>

<p>下面看bm.GetBackend(config.BackendType)函数：</p>

<pre><code class="language-go">func (bm *manager) GetBackend(backendType string) (Backend, error) {
    //传入的参数是config的BackendType，此配置项是通过configmap写入到flannel的pod中的，因此是一个固定的值，比如vxlan
   bm.mux.Lock()
   defer bm.mux.Unlock()

   betype := strings.ToLower(backendType)
   // see if one is already running
   if be, ok := bm.active[betype]; ok {
      return be, nil
   }

   // first request, need to create and run it
   befunc, ok := constructors[betype]
   if !ok {
      return nil, fmt.Errorf(&quot;unknown backend type: %v&quot;, betype)
   }

   be, err := befunc(bm.sm, bm.extIface)
   if err != nil {
      return nil, err
   }
   bm.active[betype] = be

   bm.wg.Add(1)
   go func() {
      &lt;-bm.ctx.Done()

      // TODO(eyakubovich): this obviosly introduces a race.
      // GetBackend() could get called while we are here.
      // Currently though, all backends' Run exit only
      // on shutdown

      bm.mux.Lock()
      delete(bm.active, betype)
      bm.mux.Unlock()

      bm.wg.Done()
   }()

   return be, nil
}
</code></pre>

<p>main.go的289行bn, err := be.RegisterNetwork(ctx, wg, config)，实际上调用的是具体的backend的Register，比如配置了vxlan就调用vxlan的register：</p>

<p>flannel/backend/vxlan/vxlan.go:</p>

<pre><code class="language-go">func (be *VXLANBackend) RegisterNetwork(ctx context.Context, wg sync.WaitGroup, config *subnet.Config) (backend.Network, error) {
   // Parse our configuration
   cfg := struct {
      VNI           int
      Port          int
      GBP           bool
      Learning      bool
      DirectRouting bool
   }{
      VNI: defaultVNI,
   }

   if len(config.Backend) &gt; 0 {
      if err := json.Unmarshal(config.Backend, &amp;cfg); err != nil {
         return nil, fmt.Errorf(&quot;error decoding VXLAN backend config: %v&quot;, err)
      }
   }
   log.Infof(&quot;VXLAN config: VNI=%d Port=%d GBP=%v Learning=%v DirectRouting=%v&quot;, cfg.VNI, cfg.Port, cfg.GBP, cfg.Learning, cfg.DirectRouting)

   devAttrs := vxlanDeviceAttrs{
      vni:       uint32(cfg.VNI),
      name:      fmt.Sprintf(&quot;flannel.%v&quot;, cfg.VNI),
      vtepIndex: be.extIface.Iface.Index,
      vtepAddr:  be.extIface.IfaceAddr,
      vtepPort:  cfg.Port,
      gbp:       cfg.GBP,
      learning:  cfg.Learning,
   }

   dev, err := newVXLANDevice(&amp;devAttrs)
   if err != nil {
      return nil, err
   }
   dev.directRouting = cfg.DirectRouting

   subnetAttrs, err := newSubnetAttrs(be.extIface.ExtAddr, dev.MACAddr())
   if err != nil {
      return nil, err
   }

   lease, err := be.subnetMgr.AcquireLease(ctx, subnetAttrs)
   switch err {
   case nil:
   case context.Canceled, context.DeadlineExceeded:
      return nil, err
   default:
      return nil, fmt.Errorf(&quot;failed to acquire lease: %v&quot;, err)
   }

   // Ensure that the device has a /32 address so that no broadcast routes are created.
   // This IP is just used as a source address for host to workload traffic (so
   // the return path for the traffic has an address on the flannel network to use as the destination)
   if err := dev.Configure(ip.IP4Net{IP: lease.Subnet.IP, PrefixLen: 32}); err != nil {
      return nil, fmt.Errorf(&quot;failed to configure interface %s: %s&quot;, dev.link.Attrs().Name, err)
   }

   return newNetwork(be.subnetMgr, be.extIface, dev, ip.IP4Net{}, lease)
}
</code></pre>

<p>该函数主要是创建vxlan设备。配置对应的路由，给vxlan设备配置IP信息等等。</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">qsyqian</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2019-09-12
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/flannel-pod-communication-analysis/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Flannel 模式网络详解（vxlan）</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/linux-vxlan-implement/">
            <span class="next-text nav-default">手动创建vxlan网络连接container</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:qsyqian@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/qsyqian" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://qsyqian.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        qsyqian
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
